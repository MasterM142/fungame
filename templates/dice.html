{% extends "base.html" %}

{% block title %}Dice{% endblock %}

{% block content %}
<div class="row">
    <div class="col-lg-8">
        <div class="card dice-card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5 class="mb-0">
                    <i class="fas fa-dice me-2"></i>🎲 Dice
                </h5>
                <div class="game-status">
                    <span id="game-status-text" class="badge bg-secondary">Bereit</span>
                </div>
            </div>
            <div class="card-body">
                <!-- Dice Result Display -->
                <div id="dice-result" class="text-center mb-4">
                    <div class="dice-container">
                        <div id="dice-display" class="dice-number">
                            <span id="dice-value">?</span>
                        </div>
                        <div class="dice-result-text mt-3" id="result-text"></div>
                    </div>
                </div>
                
                <!-- Game Controls -->
                <div id="game-controls" class="mb-4">
                    <!-- Prediction Slider -->
                    <div class="prediction-slider mb-4">
                        <div class="slider-header d-flex justify-content-between align-items-center mb-2">
                            <div class="slider-label">
                                <span class="badge bg-danger">0</span>
                            </div>
                            <div class="target-display">
                                <span id="target-display-value">50</span>
                            </div>
                            <div class="slider-label">
                                <span class="badge bg-success">100</span>
                            </div>
                        </div>
                        
                        <div class="slider-container position-relative">
                            <input type="range" class="form-range custom-range" id="target-slider" min="1" max="99" value="50">
                            <div class="slider-track"></div>
                            <div class="slider-fill" id="slider-fill-under"></div>
                            <div class="slider-fill" id="slider-fill-over"></div>
                        </div>
                    </div>
                    
                    <div class="row g-3">
                        <!-- Bet Amount -->
                        <div class="col-md-4">
                            <label class="form-label">
                                <i class="fas fa-coins me-1"></i>Einsatz
                            </label>
                            <div class="input-group">
                                <input type="number" id="bet-amount" class="form-control" value="10" min="1" max="{{ user.balance }}" step="0.01">
                                <span class="input-group-text">Credits</span>
                            </div>
                            <div class="bet-buttons mt-2">
                                <button class="btn btn-sm btn-outline-primary" onclick="setBet(1)">Min</button>
                                <button class="btn btn-sm btn-outline-primary" onclick="setBet({{ user.balance / 4 }})">1/4</button>
                                <button class="btn btn-sm btn-outline-primary" onclick="setBet({{ user.balance / 2 }})">1/2</button>
                                <button class="btn btn-sm btn-outline-primary" onclick="setBet({{ user.balance }})">Max</button>
                            </div>
                        </div>
                        
                        <!-- Target Number -->
                        <div class="col-md-4">
                            <label class="form-label">
                                <i class="fas fa-bullseye me-1"></i>Zielzahl
                            </label>
                            <div class="input-group">
                                <input type="number" id="target-number" class="form-control" value="50" min="1" max="99">
                                <span class="input-group-text">/ 100</span>
                            </div>
                        </div>
                        
                        <!-- Prediction Buttons -->
                        <div class="col-md-4">
                            <label class="form-label">
                                <i class="fas fa-random me-1"></i>Vorhersage
                            </label>
                            <div class="prediction-buttons">
                                <div class="btn-group w-100" role="group">
                                    <input type="radio" class="btn-check" name="prediction" id="prediction-under" value="under" autocomplete="off" checked>
                                    <label class="btn btn-outline-danger" for="prediction-under">
                                        <i class="fas fa-arrow-down me-1"></i>Unter
                                    </label>
                                    
                                    <input type="radio" class="btn-check" name="prediction" id="prediction-over" value="over" autocomplete="off">
                                    <label class="btn btn-outline-success" for="prediction-over">
                                        <i class="fas fa-arrow-up me-1"></i>Über
                                    </label>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Game Info -->
                    <div class="row mt-3">
                        <div class="col-md-4">
                            <div class="info-card">
                                <div class="info-label">Multiplier</div>
                                <div class="info-value" id="multiplier">2.00x</div>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="info-card">
                                <div class="info-label">Gewinnchance</div>
                                <div class="info-value" id="win-chance">49.50%</div>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="info-card">
                                <div class="info-label">Möglicher Gewinn</div>
                                <div class="info-value text-success" id="potential-win">20.00</div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Roll Button -->
                    <div class="row mt-3">
                        <div class="col-12">
                            <div class="d-grid">
                                <button id="roll-dice" class="btn btn-primary btn-lg">
                                    <i class="fas fa-dice me-2"></i>Würfeln
                                </button>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Advanced Controls -->
                    <div class="row mt-3">
                        <div class="col-md-6">
                            <div class="d-grid">
                                <button id="auto-bet-btn" class="btn btn-warning btn-lg">
                                    <i class="fas fa-robot me-2"></i>Auto Bet
                                </button>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="d-grid">
                                <button id="martingale-btn" class="btn btn-info btn-lg">
                                    <i class="fas fa-chart-line me-2"></i>Martingale
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Dice History -->
                <div id="dice-history" class="mt-4">
                    <h6 class="mb-3">
                        <i class="fas fa-history me-2"></i>Letzte Würfe
                    </h6>
                    <div class="dice-history-container">
                        <div id="history-list" class="d-flex flex-wrap gap-2"></div>
                    </div>
                </div>
                
                <!-- Quick Presets -->
                <div class="mt-4">
                    <h6 class="mb-3">
                        <i class="fas fa-bolt me-2"></i>Schnellwahl
                    </h6>
                    <div class="quick-presets">
                        <div class="row g-2">
                            <div class="col-md-3 col-6">
                                <button class="btn btn-outline-primary w-100" onclick="setPreset(25, 'under')">
                                    <div class="preset-value">Unter 25</div>
                                    <div class="preset-multiplier">4.00x</div>
                                </button>
                            </div>
                            <div class="col-md-3 col-6">
                                <button class="btn btn-outline-primary w-100" onclick="setPreset(50, 'under')">
                                    <div class="preset-value">Unter 50</div>
                                    <div class="preset-multiplier">2.00x</div>
                                </button>
                            </div>
                            <div class="col-md-3 col-6">
                                <button class="btn btn-outline-primary w-100" onclick="setPreset(75, 'over')">
                                    <div class="preset-value">Über 75</div>
                                    <div class="preset-multiplier">4.00x</div>
                                </button>
                            </div>
                            <div class="col-md-3 col-6">
                                <button class="btn btn-outline-primary w-100" onclick="setPreset(90, 'over')">
                                    <div class="preset-value">Über 90</div>
                                    <div class="preset-multiplier">10.00x</div>
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Sidebar -->
    <div class="col-lg-4">
        <!-- Statistics -->
        <div class="card mb-4">
            <div class="card-header">
                <h6 class="mb-0">
                    <i class="fas fa-chart-bar me-2"></i>Statistiken
                </h6>
            </div>
            <div class="card-body">
                <div class="stat-item">
                    <span class="stat-label">Balance:</span>
                    <span class="stat-value text-success" id="user-balance">{{ "%.2f"|format(user.balance) }} Credits</span>
                </div>
                <div class="stat-item">
                    <span class="stat-label">Spiele gespielt:</span>
                    <span class="stat-value" id="games-played">{{ user.games_played }}</span>
                </div>
                <div class="stat-item">
                    <span class="stat-label">Gesamt gewonnen:</span>
                    <span class="stat-value text-success" id="total-won">{{ "%.2f"|format(user.total_won) }}</span>
                </div>
                <div class="stat-item">
                    <span class="stat-label">Profit:</span>
                    <span class="stat-value {% if user.total_won - user.total_wagered >= 0 %}text-success{% else %}text-danger{% endif %}" id="profit">
                        {{ "%.2f"|format(user.total_won - user.total_wagered) }}
                    </span>
                </div>
            </div>
        </div>
        
        <!-- Session Stats -->
        <div class="card mb-4">
            <div class="card-header">
                <h6 class="mb-0">
                    <i class="fas fa-stopwatch me-2"></i>Session Statistiken
                </h6>
            </div>
            <div class="card-body">
                <div class="session-stats">
                    <div class="row text-center">
                        <div class="col-6">
                            <div class="session-stat-item">
                                <div class="session-stat-value" id="session-bets">0</div>
                                <div class="session-stat-label">Würfe</div>
                            </div>
                        </div>
                        <div class="col-6">
                            <div class="session-stat-item">
                                <div class="session-stat-value" id="session-winrate">0%</div>
                                <div class="session-stat-label">Gewinnrate</div>
                            </div>
                        </div>
                    </div>
                    <div class="row text-center mt-3">
                        <div class="col-6">
                            <div class="session-stat-item">
                                <div class="session-stat-value" id="session-streak">0</div>
                                <div class="session-stat-label">Streak</div>
                            </div>
                        </div>
                        <div class="col-6">
                            <div class="session-stat-item">
                                <div class="session-stat-value" id="session-best-streak">0</div>
                                <div class="session-stat-label">Beste Streak</div>
                            </div>
                        </div>
                    </div>
                    <div class="row text-center mt-3">
                        <div class="col-6">
                            <div class="session-stat-item">
                                <div class="session-stat-value text-success" id="session-profit">0.00</div>
                                <div class="session-stat-label">Profit</div>
                            </div>
                        </div>
                        <div class="col-6">
                            <div class="session-stat-item">
                                <div class="session-stat-value text-success" id="session-best-win">0.00</div>
                                <div class="session-stat-label">Bester Gewinn</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Hot/Cold Numbers -->
        <div class="card mb-4">
            <div class="card-header">
                <h6 class="mb-0">
                    <i class="fas fa-fire me-2"></i>Hot & Cold Zahlen
                </h6>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-6">
                        <h6 class="text-danger mb-2">
                            <i class="fas fa-fire-alt me-1"></i>Hot
                        </h6>
                        <div id="hot-numbers" class="d-flex flex-wrap gap-1"></div>
                    </div>
                    <div class="col-6">
                        <h6 class="text-primary mb-2">
                            <i class="fas fa-snowflake me-1"></i>Cold
                        </h6>
                        <div id="cold-numbers" class="d-flex flex-wrap gap-1"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Toast Container -->
<div id="toast-container" class="position-fixed bottom-0 end-0 p-3" style="z-index: 5"></div>

<style>
.dice-card {
    background: linear-gradient(135deg, rgba(37, 43, 61, 0.95), rgba(26, 31, 46, 0.95));
    border: 1px solid var(--border-color);
    box-shadow: 0 20px 40px rgba(0, 0, 0, 0.3);
}

.dice-container {
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    padding: 2rem;
}

.dice-number {
    font-size: 3rem;
    font-weight: bold;
    color: var(--accent-primary);
    background: var(--bg-tertiary);
    border: 3px solid var(--accent-primary);
    border-radius: 20px;
    width: 120px;
    height: 120px;
    display: flex;
    align-items: center;
    justify-content: center;
    margin: 0 auto;
    transition: all 0.3s ease;
    position: relative;
    overflow: hidden;
}

.dice-number::before {
    content: '';
    position: absolute;
    top: -50%;
    left: -50%;
    width: 200%;
    height: 200%;
    background: linear-gradient(
        45deg,
        transparent,
        rgba(255, 255, 255, 0.1),
        transparent
    );
    transform: rotate(45deg);
    animation: shine 3s infinite;
}

@keyframes shine {
    0% {
        top: -50%;
        left: -50%;
    }
    100% {
        top: 150%;
        left: 150%;
    }
}

.dice-number.rolling {
    animation: diceRoll 1s ease-in-out;
}

@keyframes diceRoll {
    0%, 100% { transform: rotate(0deg) scale(1); }
    25% { transform: rotate(90deg) scale(1.1); }
    50% { transform: rotate(180deg) scale(1.2); }
    75% { transform: rotate(270deg) scale(1.1); }
}

.dice-number.win {
    border-color: var(--accent-success);
    color: var(--accent-success);
    box-shadow: 0 0 20px rgba(16, 185, 129, 0.5);
}

.dice-number.lose {
    border-color: var(--accent-danger);
    color: var(--accent-danger);
    box-shadow: 0 0 20px rgba(239, 68, 68, 0.5);
}

.dice-result-text {
    font-size: 1.2rem;
    font-weight: 600;
    min-height: 2rem;
}

/* Custom Range Slider */
.prediction-slider {
    padding: 1rem;
    background: rgba(26, 31, 46, 0.5);
    border-radius: 12px;
    border: 1px solid var(--border-color);
}

.target-display {
    font-size: 1.5rem;
    font-weight: 700;
    color: var(--accent-primary);
    background: var(--bg-tertiary);
    border-radius: 50%;
    width: 50px;
    height: 50px;
    display: flex;
    align-items: center;
    justify-content: center;
    margin: 0 auto;
    border: 2px solid var(--accent-primary);
}

.slider-container {
    height: 30px;
    display: flex;
    align-items: center;
}

.custom-range {
    position: relative;
    z-index: 2;
    height: 8px;
}

.slider-track {
    position: absolute;
    top: 50%;
    transform: translateY(-50%);
    left: 0;
    right: 0;
    height: 8px;
    background: var(--border-color);
    border-radius: 4px;
}

.slider-fill {
    position: absolute;
    top: 50%;
    transform: translateY(-50%);
    height: 8px;
    border-radius: 4px;
}

#slider-fill-under {
    left: 0;
    width: 50%;
    background: linear-gradient(90deg, var(--accent-danger), #dc2626);
}

#slider-fill-over {
    right: 0;
    width: 50%;
    background: linear-gradient(90deg, #059669, var(--accent-success));
}

.custom-range::-webkit-slider-thumb {
    -webkit-appearance: none;
    appearance: none;
    width: 24px;
    height: 24px;
    border-radius: 50%;
    background: var(--accent-primary);
    cursor: pointer;
    border: 2px solid white;
    box-shadow: 0 0 10px rgba(0, 212, 255, 0.5);
}

.custom-range::-moz-range-thumb {
    width: 24px;
    height: 24px;
    border-radius: 50%;
    background: var(--accent-primary);
    cursor: pointer;
    border: 2px solid white;
    box-shadow: 0 0 10px rgba(0, 212, 255, 0.5);
}

.info-card {
    background: rgba(37, 43, 61, 0.6);
    border: 1px solid var(--border-color);
    border-radius: 12px;
    padding: 1rem;
    text-align: center;
    transition: all 0.3s ease;
}

.info-card:hover {
    border-color: var(--accent-primary);
    box-shadow: 0 5px 15px rgba(0, 212, 255, 0.2);
}

.info-label {
    font-size: 0.85rem;
    color: var(--text-secondary);
    margin-bottom: 0.5rem;
}

.info-value {
    font-size: 1.25rem;
    font-weight: 700;
}

.bet-buttons {
    display: flex;
    gap: 0.25rem;
}

.bet-buttons .btn {
    flex: 1;
    padding: 0.25rem 0.5rem;
    font-size: 0.75rem;
}

.stat-item {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 0.5rem 0;
    border-bottom: 1px solid var(--border-color);
}

.stat-item:last-child {
    border-bottom: none;
}

.stat-label {
    color: var(--text-secondary);
    font-size: 0.9rem;
}

.stat-value {
    font-weight: 600;
}

.game-status .badge {
    font-size: 0.8rem;
    padding: 0.5rem 1rem;
}

.history-item {
    width: 40px;
    height: 40px;
    border-radius: 8px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-weight: bold;
    font-size: 0.9rem;
    transition: all 0.3s ease;
}

.history-item.win {
    background: var(--accent-success);
    color: white;
}

.history-item.lose {
    background: var(--accent-danger);
    color: white;
}

.dice-history-container {
    max-width: 100%;
    overflow-x: auto;
    padding-bottom: 0.5rem;
}

.session-stat-item {
    padding: 0.5rem;
    border-radius: 8px;
    background: rgba(37, 43, 61, 0.4);
    transition: all 0.3s ease;
}

.session-stat-item:hover {
    background: rgba(37, 43, 61, 0.6);
    transform: translateY(-2px);
}

.session-stat-value {
    font-size: 1.2rem;
    font-weight: 700;
}

.session-stat-label {
    font-size: 0.8rem;
    color: var(--text-secondary);
}

.quick-presets .btn {
    padding: 0.5rem;
    transition: all 0.3s ease;
}

.quick-presets .btn:hover {
    transform: translateY(-2px);
}

.preset-value {
    font-weight: 600;
    font-size: 0.9rem;
}

.preset-multiplier {
    font-size: 0.8rem;
    color: var(--text-secondary);
}

/* Toast styling */
.toast {
    backdrop-filter: blur(10px);
}

.btn-close-white {
    margin-right: 0 !important;
}

/* Fix for the close button */
.btn-close {
    margin-right: 0 !important;
    margin-left: 0.5rem !important;
}

/* Particle animation */
.particle {
    position: fixed;
    border-radius: 50%;
    pointer-events: none;
    opacity: 0.8;
    z-index: 9999;
    animation: particleAnimation 1s forwards;
}

@keyframes particleAnimation {
    0% {
        transform: translate(0, 0) scale(1);
        opacity: 0.8;
    }
    100% {
        transform: translate(var(--tx), var(--ty)) scale(0);
        opacity: 0;
    }
}

/* Responsive */
@media (max-width: 768px) {
    .dice-number {
        width: 100px;
        height: 100px;
        font-size: 2.5rem;
    }
    
    .info-value {
        font-size: 1rem;
    }
    
    .session-stat-value {
        font-size: 1rem;
    }
    
    .target-display {
        width: 40px;
        height: 40px;
        font-size: 1.2rem;
    }
    
    .custom-range::-webkit-slider-thumb {
        width: 20px;
        height: 20px;
    }
    
    .custom-range::-moz-range-thumb {
        width: 20px;
        height: 20px;
    }
}
</style>
{% endblock %}

{% block scripts %}
<script>
let userBalance = {{ user.balance }};
let gamesPlayed = {{ user.games_played }};
let totalWon = {{ user.total_won }};
let totalWagered = {{ user.total_wagered }};
let gameHistory = [];
let numberFrequency = {};
let sessionStats = {
    totalBets: 0,
    totalWins: 0,
    totalLosses: 0,
    currentStreak: 0,
    bestStreak: 0,
    profit: 0,
    biggestWin: 0
};
let autoBetActive = false;
let autoBetInterval;
let martingaleActive = false;
let baseBet = 0;
let currentMartingaleBet = 0;

document.addEventListener('DOMContentLoaded', function() {
    // Initialize game
    updateMultiplier();
    updateSessionStats();
    updateHotColdDisplay();
    
    // Event listeners
    document.getElementById('target-number').addEventListener('input', function() {
        const value = parseInt(this.value);
        if (value < 1) this.value = 1;
        if (value > 99) this.value = 99;
        document.getElementById('target-slider').value = this.value;
        document.getElementById('target-display-value').textContent = this.value;
        updateSliderFill(this.value);
        updateMultiplier();
    });
    
    document.getElementById('target-slider').addEventListener('input', function() {
        const value = parseInt(this.value);
        document.getElementById('target-number').value = value;
        document.getElementById('target-display-value').textContent = value;
        updateSliderFill(value);
        updateMultiplier();
    });
    
    document.querySelectorAll('input[name="prediction"]').forEach(radio => {
        radio.addEventListener('change', updateMultiplier);
    });
    
    document.getElementById('bet-amount').addEventListener('input', function() {
        const maxBet = parseFloat(this.max);
        const currentBet = parseFloat(this.value);
        if (currentBet > maxBet) {
            this.value = maxBet;
        }
        if (currentBet < 1) {
            this.value = 1;
        }
        updateMultiplier();
    });
    
    document.getElementById('roll-dice').addEventListener('click', rollDice);
    document.getElementById('auto-bet-btn').addEventListener('click', toggleAutoBet);
    document.getElementById('martingale-btn').addEventListener('click', toggleMartingale);
    
    // Load saved settings
    const savedBet = localStorage.getItem('diceBetAmount');
    const savedTarget = localStorage.getItem('diceTargetNumber');
    const savedPrediction = localStorage.getItem('dicePrediction');
    
    if (savedBet) {
        document.getElementById('bet-amount').value = savedBet;
    }
    if (savedTarget) {
        document.getElementById('target-number').value = savedTarget;
        document.getElementById('target-slider').value = savedTarget;
        document.getElementById('target-display-value').textContent = savedTarget;
        updateSliderFill(savedTarget);
    }
    if (savedPrediction) {
        document.querySelector(`input[name="prediction"][value="${savedPrediction}"]`).checked = true;
    }
    
    updateMultiplier();
    
    // Keyboard shortcuts
    document.addEventListener('keydown', function(e) {
        if (e.code === 'Space' && !document.getElementById('roll-dice').disabled) {
            e.preventDefault();
            rollDice();
        }
    });
});

function updateSliderFill(value) {
    const underWidth = value + '%';
    const overWidth = (100 - value) + '%';
    
    document.getElementById('slider-fill-under').style.width = underWidth;
    document.getElementById('slider-fill-over').style.width = overWidth;
}

function updateMultiplier() {
    const targetNumber = parseInt(document.getElementById('target-number').value);
    const prediction = document.querySelector('input[name="prediction"]:checked').value;
    const betAmount = parseFloat(document.getElementById('bet-amount').value) || 0;
    
    let winChance;
    if (prediction === 'over') {
        winChance = (99 - targetNumber) / 100;
    } else {
        winChance = targetNumber / 100;
    }
    
    const multiplier = 0.99 / winChance;
    const potentialWin = betAmount * multiplier;
    
    document.getElementById('multiplier').textContent = multiplier.toFixed(2) + 'x';
    document.getElementById('win-chance').textContent = (winChance * 100).toFixed(2) + '%';
    document.getElementById('potential-win').textContent = potentialWin.toFixed(2);
    
    // Save settings
    localStorage.setItem('diceBetAmount', document.getElementById('bet-amount').value);
    localStorage.setItem('diceTargetNumber', targetNumber);
    localStorage.setItem('dicePrediction', prediction);
}

function rollDice() {
    const betAmount = parseFloat(document.getElementById('bet-amount').value);
    const targetNumber = parseInt(document.getElementById('target-number').value);
    const prediction = document.querySelector('input[name="prediction"]:checked').value;
    
    if (betAmount <= 0 || betAmount > userBalance) {
        showToast('Ungültiger Einsatz!', 'danger');
        return;
    }
    
    if (targetNumber < 1 || targetNumber > 99) {
        showToast('Zielzahl muss zwischen 1 und 99 sein!', 'danger');
        return;
    }
    
    // Update game status
    updateGameStatus('Würfelt...', 'warning');
    
    // Disable roll button
    const rollButton = document.getElementById('roll-dice');
    rollButton.disabled = true;
    rollButton.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Würfelt...';
    
    // Start dice animation
    const diceDisplay = document.getElementById('dice-display');
    const diceValue = document.getElementById('dice-value');
    diceDisplay.classList.add('rolling');
    diceDisplay.classList.remove('win', 'lose');
    
    // Animate random numbers
    let animationCount = 0;
    const animationInterval = setInterval(() => {
        diceValue.textContent = Math.floor(Math.random() * 100) + 1;
        animationCount++;
        
        if (animationCount >= 10) {
            clearInterval(animationInterval);
            
            // Make API call
            fetch('/api/dice/roll', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    bet_amount: betAmount,
                    target_number: targetNumber,
                    prediction: prediction
                })
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error('Server responded with status: ' + response.status);
                }
                return response.json();
            })
            .then(data => {
                // Show final result
                diceDisplay.classList.remove('rolling');
                diceValue.textContent = data.dice_result;
                
                // Update user balance
                userBalance = data.new_balance;
                gamesPlayed++;
                
                if (data.won) {
                    diceDisplay.classList.add('win');
                    document.getElementById('result-text').innerHTML = 
                        `<span class="text-success">🎉 Gewonnen! +${data.win_amount.toFixed(2)} Credits</span>`;
                    playSound('winSound');
                    createParticles(diceDisplay);
                    updateGameStatus('Gewonnen!', 'success');
                    
                    // Update stats
                    totalWon += data.win_amount;
                    
                    // Update session stats
                    sessionStats.totalBets++;
                    sessionStats.totalWins++;
                    sessionStats.currentStreak++;
                    sessionStats.profit += data.win_amount - betAmount;
                    
                    if (sessionStats.currentStreak > sessionStats.bestStreak) {
                        sessionStats.bestStreak = sessionStats.currentStreak;
                    }
                    
                    if (data.win_amount > sessionStats.biggestWin) {
                        sessionStats.biggestWin = data.win_amount;
                    }
                } else {
                    diceDisplay.classList.add('lose');
                    document.getElementById('result-text').innerHTML = 
                        `<span class="text-danger">💔 Verloren! -${betAmount.toFixed(2)} Credits</span>`;
                    playSound('loseSound');
                    updateGameStatus('Verloren!', 'danger');
                    
                    // Update stats
                    totalWagered += betAmount;
                    
                    // Update session stats
                    sessionStats.totalBets++;
                    sessionStats.totalLosses++;
                    sessionStats.currentStreak = 0;
                    sessionStats.profit -= betAmount;
                }
                
                // Add to history
                addToHistory(data.dice_result, data.won);
                
                // Track number frequency
                trackNumber(data.dice_result);
                
                // Update displays
                updateUserStats();
                updateSessionStats();
                updateHotColdDisplay();
                
                // Re-enable button
                rollButton.disabled = false;
                rollButton.innerHTML = '<i class="fas fa-dice me-2"></i>Würfeln';
                
                // Update max bet
                document.getElementById('bet-amount').max = userBalance;
                
                // Handle martingale strategy
                if (martingaleActive) {
                    if (data.won) {
                        // Reset to base bet after a win
                        currentMartingaleBet = baseBet;
                    } else {
                        // Double bet after a loss, but check if we have enough balance
                        currentMartingaleBet = Math.min(currentMartingaleBet * 2, userBalance);
                    }
                    
                    // Update bet amount
                    document.getElementById('bet-amount').value = currentMartingaleBet.toFixed(2);
                    updateMultiplier();
                }
                
                // Continue auto-betting if active
                if (autoBetActive) {
                    setTimeout(() => {
                        if (!document.getElementById('roll-dice').disabled) {
                            rollDice();
                        }
                    }, 2000);
                }
            })
            .catch(error => {
                console.error('Error:', error);
                diceDisplay.classList.remove('rolling');
                document.getElementById('result-text').innerHTML = 
                    `<span class="text-danger">⚠️ Fehler: ${error.message}</span>`;
                updateGameStatus('Fehler!', 'danger');
                
                // Re-enable button
                rollButton.disabled = false;
                rollButton.innerHTML = '<i class="fas fa-dice me-2"></i>Würfeln';
            });
        }
    }, 100);
    
    playSound('clickSound');
}

function addToHistory(result, won) {
    gameHistory.unshift({ result, won });
    if (gameHistory.length > 20) {
        gameHistory.pop();
    }
    
    const historyList = document.getElementById('history-list');
    historyList.innerHTML = '';
    
    gameHistory.forEach(game => {
        const historyItem = document.createElement('div');
        historyItem.className = `history-item ${game.won ? 'win' : 'lose'}`;
        historyItem.textContent = game.result;
        historyList.appendChild(historyItem);
    });
}

function trackNumber(number) {
    numberFrequency[number] = (numberFrequency[number] || 0) + 1;
    updateHotColdDisplay();
}

function getHotNumbers() {
    const entries = Object.entries(numberFrequency);
    if (entries.length === 0) return [];
    
    return entries
        .sort(([, a], [, b]) => b - a)
        .slice(0, 5)
        .map(([num]) => parseInt(num));
}

function getColdNumbers() {
    const entries = Object.entries(numberFrequency);
    if (entries.length === 0) return [];
    
    // Get numbers that haven't appeared yet
    const allNumbers = Array.from({length: 100}, (_, i) => i + 1);
    const unrolled = allNumbers.filter(num => !numberFrequency[num]);
    
    // Get numbers with lowest frequency
    const lowestFrequency = entries
        .sort(([, a], [, b]) => a - b)
        .slice(0, 5)
        .map(([num]) => parseInt(num));
    
    // Combine both lists, prioritizing unrolled numbers
    return [...unrolled.slice(0, 5), ...lowestFrequency].slice(0, 5);
}

function updateHotColdDisplay() {
    const hotNumbers = getHotNumbers();
    const coldNumbers = getColdNumbers();
    
    document.getElementById('hot-numbers').innerHTML = hotNumbers
        .map(num => `<span class="badge bg-danger">${num}</span>`)
        .join(' ');
    
    document.getElementById('cold-numbers').innerHTML = coldNumbers
        .map(num => `<span class="badge bg-primary">${num}</span>`)
        .join(' ');
}

function updateSessionStats() {
    document.getElementById('session-bets').textContent = sessionStats.totalBets;
    
    const winRate = sessionStats.totalBets > 0 
        ? ((sessionStats.totalWins / sessionStats.totalBets) * 100).toFixed(1) 
        : '0.0';
    document.getElementById('session-winrate').textContent = winRate + '%';
    
    document.getElementById('session-streak').textContent = sessionStats.currentStreak;
    document.getElementById('session-best-streak').textContent = sessionStats.bestStreak;
    
    const profitElement = document.getElementById('session-profit');
    profitElement.textContent = sessionStats.profit.toFixed(2);
    profitElement.className = sessionStats.profit >= 0 
        ? 'session-stat-value text-success' 
        : 'session-stat-value text-danger';
    
    document.getElementById('session-best-win').textContent = sessionStats.biggestWin.toFixed(2);
}

function updateUserStats() {
    // Update displayed balance
    document.getElementById('user-balance').textContent = userBalance.toFixed(2) + ' Credits';
    
    // Update games played
    document.getElementById('games-played').textContent = gamesPlayed;
    
    // Update total won
    document.getElementById('total-won').textContent = totalWon.toFixed(2);
    
    // Update profit
    const profit = totalWon - totalWagered;
    const profitElement = document.getElementById('profit');
    profitElement.textContent = profit.toFixed(2);
    profitElement.className = profit >= 0 ? 'stat-value text-success' : 'stat-value text-danger';
}

function setPreset(target, prediction) {
    document.getElementById('target-number').value = target;
    document.getElementById('target-slider').value = target;
    document.getElementById('target-display-value').textContent = target;
    document.querySelector(`input[name="prediction"][value="${prediction}"]`).checked = true;
    updateSliderFill(target);
    updateMultiplier();
    playSound('clickSound');
}

function setBet(amount) {
    const betInput = document.getElementById('bet-amount');
    const maxBet = parseFloat(betInput.max);
    const newBet = Math.min(Math.max(amount, 1), maxBet);
    betInput.value = newBet.toFixed(2);
    updateMultiplier();
    playSound('clickSound');
}

function toggleAutoBet() {
    if (autoBetActive) {
        clearInterval(autoBetInterval);
        autoBetActive = false;
        document.getElementById('auto-bet-btn').innerHTML = '<i class="fas fa-robot me-2"></i>Auto Bet';
        document.getElementById('auto-bet-btn').classList.remove('btn-danger');
        document.getElementById('auto-bet-btn').classList.add('btn-warning');
        updateGameStatus('Bereit', 'secondary');
    } else {
        autoBetActive = true;
        document.getElementById('auto-bet-btn').innerHTML = '<i class="fas fa-stop-circle me-2"></i>Stop Auto';
        document.getElementById('auto-bet-btn').classList.remove('btn-warning');
        document.getElementById('auto-bet-btn').classList.add('btn-danger');
        updateGameStatus('Auto Bet aktiv', 'warning');
        
        // First roll immediately
        if (!document.getElementById('roll-dice').disabled) {
            rollDice();
        }
    }
}

function toggleMartingale() {
    if (martingaleActive) {
        martingaleActive = false;
        document.getElementById('martingale-btn').innerHTML = '<i class="fas fa-chart-line me-2"></i>Martingale';
        document.getElementById('martingale-btn').classList.remove('btn-danger');
        document.getElementById('martingale-btn').classList.add('btn-info');
        showToast('Martingale deaktiviert', 'info');
    } else {
        martingaleActive = true;
        baseBet = parseFloat(document.getElementById('bet-amount').value);
        currentMartingaleBet = baseBet;
        document.getElementById('martingale-btn').innerHTML = '<i class="fas fa-stop-circle me-2"></i>Stop Martingale';
        document.getElementById('martingale-btn').classList.remove('btn-info');
        document.getElementById('martingale-btn').classList.add('btn-danger');
        
        showToast('Martingale aktiviert! Verluste werden automatisch verdoppelt.', 'info');
    }
}

function updateGameStatus(text, type) {
    const statusElement = document.getElementById('game-status-text');
    statusElement.textContent = text;
    statusElement.className = `badge bg-${type}`;
}

function showToast(message, type) {
    // Check if toast container exists, if not create it
    let toastContainer = document.getElementById('toast-container');
    if (!toastContainer) {
        toastContainer = document.createElement('div');
        toastContainer.id = 'toast-container';
        toastContainer.className = 'position-fixed bottom-0 end-0 p-3';
        toastContainer.style.zIndex = '5';
        document.body.appendChild(toastContainer);
    }
    
    // Create toast element
    const toastId = 'toast-' + Date.now();
    const toastHtml = `
        <div id="${toastId}" class="toast align-items-center text-white bg-${type} border-0" role="alert" aria-live="assertive" aria-atomic="true">
            <div class="d-flex">
                <div class="toast-body">
                    ${message}
                </div>
                <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast" aria-label="Close"></button>
            </div>
        </div>
    `;
    
    toastContainer.insertAdjacentHTML('beforeend', toastHtml);
    
    // Initialize and show toast
    const toastElement = document.getElementById(toastId);
    const toast = new bootstrap.Toast(toastElement, { delay: 5000 });
    toast.show();
    
    // Remove toast after it's hidden
    toastElement.addEventListener('hidden.bs.toast', function() {
        toastElement.remove();
    });
}

function createParticles(element) {
    const rect = element.getBoundingClientRect();
    const centerX = rect.left + rect.width / 2;
    const centerY = rect.top + rect.height / 2;
    
    for (let i = 0; i < 30; i++) {
        const particle = document.createElement('div');
        particle.className = 'particle';
        particle.style.position = 'fixed';
        particle.style.width = '10px';
        particle.style.height = '10px';
        particle.style.borderRadius = '50%';
        particle.style.backgroundColor = getRandomColor();
        particle.style.left = centerX + 'px';
        particle.style.top = centerY + 'px';
        particle.style.zIndex = '9999';
        particle.style.pointerEvents = 'none';
        
        document.body.appendChild(particle);
        
        const angle = Math.random() * Math.PI * 2;
        const speed = 5 + Math.random() * 15;
        const tx = Math.cos(angle) * speed * 20;
        const ty = Math.sin(angle) * speed * 20;
        
        particle.style.setProperty('--tx', tx + 'px');
        particle.style.setProperty('--ty', ty + 'px');
        
        // Remove particle after animation completes
        particle.addEventListener('animationend', () => {
            particle.remove();
        });
    }
}

function getRandomColor() {
    const colors = ['#00d4ff', '#7c3aed', '#10b981', '#f59e0b', '#ef4444'];
    return colors[Math.floor(Math.random() * colors.length)];
}

function playSound(soundId) {
    const sound = document.getElementById(soundId);
    if (sound) {
        sound.currentTime = 0;
        sound.play().catch(e => console.log('Sound play failed:', e));
    }
}

// Add visual feedback for successful actions
function addSuccessEffect(element) {
    element.style.boxShadow = '0 0 20px rgba(16, 185, 129, 0.6)';
    setTimeout(() => {
        element.style.boxShadow = '';
    }, 1000);
}

// Performance optimization: Debounce rapid clicks
function debounce(func, wait) {
    let timeout;
    return function executedFunction(...args) {
        const later = () => {
            clearTimeout(timeout);
            func(...args);
        };
        clearTimeout(timeout);
        timeout = setTimeout(later, wait);
    };
}

// Initialize slider fill on page load
document.addEventListener('DOMContentLoaded', function() {
    const initialValue = parseInt(document.getElementById('target-slider').value);
    updateSliderFill(initialValue);
});
</script>
{% endblock %}
